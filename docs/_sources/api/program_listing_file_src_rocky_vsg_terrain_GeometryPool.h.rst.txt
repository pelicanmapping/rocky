
.. _program_listing_file_src_rocky_vsg_terrain_GeometryPool.h:

Program Listing for File GeometryPool.h
=======================================

|exhale_lsh| :ref:`Return to documentation for file <file_src_rocky_vsg_terrain_GeometryPool.h>` (``src/rocky/vsg/terrain/GeometryPool.h``)

.. |exhale_lsh| unicode:: U+021B0 .. UPWARDS ARROW WITH TIP LEFTWARDS

.. code-block:: cpp

   
   #pragma once
   
   #include <rocky/Math.h>
   #include <rocky/TileKey.h>
   #include <rocky/IOTypes.h>
   #include <rocky/vsg/VSGContext.h>
   #include <map>
   
   #define VERTEX_VISIBLE       1 // draw it
   #define VERTEX_BOUNDARY      2 // vertex lies on a skirt boundary
   #define VERTEX_HAS_ELEVATION 4 // not subject to elevation texture
   #define VERTEX_SKIRT         8 // it's a skirt vertex (bitmask)
   #define VERTEX_CONSTRAINT   16 // part of a non-morphable constraint
   
   namespace ROCKY_NAMESPACE
   {
       class Map;
       class MeshEditor;
       class TerrainSettings;
   
       class SharedGeometry : public vsg::Inherit<vsg::Geometry, SharedGeometry>
       {
       public:
           SharedGeometry() = default;
   
           inline bool empty() const {
               return commands.empty();
           }
   
           bool hasConstraints = false;
           vsg::ref_ptr<vsg::vec3Array> verts, normals, uvs; // originals
           vsg::ref_ptr<vsg::ushortArray> indexArray; // original indices
       };
   
   
       struct GeometryKey
       {
           GeometryKey() :
               lod(-1),
               tileY(0),
               patch(false),
               size(0u)
           {
               //nop
           }
   
           GeometryKey(const GeometryKey& rhs) :
               lod(rhs.lod),
               tileY(rhs.tileY),
               patch(rhs.patch),
               size(rhs.size)
           {
               //nop
           }
   
           bool operator < (const GeometryKey& rhs) const
           {
               if (lod < rhs.lod) return true;
               if (lod > rhs.lod) return false;
               if (tileY < rhs.tileY) return true;
               if (tileY > rhs.tileY) return false;
               if (size < rhs.size) return true;
               if (size > rhs.size) return false;
               if (patch == false && rhs.patch == true) return true;
               return false;
           }
   
           bool operator == (const GeometryKey& rhs) const
           {
               return
                   lod == rhs.lod &&
                   tileY == rhs.tileY &&
                   size == rhs.size &&
                   patch == rhs.patch;
           }
   
           bool operator != (const GeometryKey& rhs) const
           {
               return
                   lod != rhs.lod ||
                   tileY != rhs.tileY ||
                   size != rhs.size ||
                   patch != rhs.patch;
           }
   
           int      lod;
           int      tileY;
           bool     patch;
           unsigned size;
       };
   }
   
   
   namespace ROCKY_NAMESPACE
   {
       class Profile;
   
       class GeometryPool
       {
       public:
           GeometryPool(const SRS& renderingSRS);
   
           using SharedGeometries = std::map<GeometryKey, vsg::ref_ptr<SharedGeometry>>;
   
           struct Settings {
               uint32_t tileSize = 17u;
               float skirtRatio = 0.0f;
               bool morphing = false;
           };
   
           vsg::ref_ptr<SharedGeometry> getPooledGeometry(
               const TileKey& tileKey,
               const Settings& settings,
               Cancelable* state) const;
   
           int getNumSkirtElements(const Settings& settings) const;
   
           void clear();
   
           void sweep(VSGContext& context);
   
           inline std::size_t size() const;
   
           bool enabled = true;
   
           bool debug = false;
   
       private:
   
           SRS _renderingSRS;
           mutable detail::Gate<GeometryKey> _keygate;
           mutable std::mutex _mutex;
           mutable SharedGeometries _sharedGeometries;
           mutable vsg::ref_ptr<vsg::ushortArray> _defaultIndices;
           Settings _defaultIndicesSettings;
   
           void createKeyForTileKey(
               const TileKey& tileKey,
               unsigned size,
               GeometryKey& out) const;
   
           vsg::ref_ptr<SharedGeometry> createGeometry(
               const TileKey& tileKey,
               const Settings& settings,
               Cancelable* progress) const;
   
           // builds a primitive set to use for any tile without a mask
           vsg::ref_ptr<vsg::ushortArray> createIndices(
               const Settings& settings) const;
       };
   
       // inlines
       std::size_t GeometryPool::size() const {
           return _sharedGeometries.size();
       }
   
   }
   
