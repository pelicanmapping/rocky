

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Program Listing for File MapManipulator.cpp &mdash; Rocky SDK 0.9.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=29de89ba" />
      <link rel="stylesheet" type="text/css" href="../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=29de89ba" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=1a282f62"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
      <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            Rocky SDK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guides/getting_started.html">Getting Started with Rocky</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/maps_and_layers.html">Maps and Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/ecs_system.html">Entity Component System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/hello_world.html">Hello World</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rocky SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Program Listing for File MapManipulator.cpp</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/program_listing_file_src_rocky_vsg_MapManipulator.cpp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="program-listing-for-file-mapmanipulator-cpp">
<span id="program-listing-file-src-rocky-vsg-mapmanipulator-cpp"></span><h1>Program Listing for File MapManipulator.cpp<a class="headerlink" href="#program-listing-for-file-mapmanipulator-cpp" title="Link to this heading"></a></h1>
<p>↰ <a class="reference internal" href="file_src_rocky_vsg_MapManipulator.cpp.html#file-src-rocky-vsg-mapmanipulator-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">src/rocky/vsg/MapManipulator.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;MapManipulator.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;MapNode.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;VSGUtils.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rocky/Units.h&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ROCKY_NAMESPACE</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ROCKY_NAMESPACE</span><span class="o">::</span><span class="nn">util</span><span class="p">;</span>

<span class="cp">#undef LC</span>
<span class="cp">#define LC &quot;[MapManipulator] &quot;</span>

<span class="cp">#define TEST_OUT if(true) Log::info()</span>
<span class="cp">#define NOT_YET_IMPLEMENTED(X) ROCKY_TODO(X)</span>

<span class="cp">#undef EPSILON</span>
<span class="cp">#define EPSILON 1e-6</span>

<span class="k">namespace</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// a reasonable approximation of cosine interpolation</span>
<span class="w">    </span><span class="kt">double</span>
<span class="w">    </span><span class="nf">smoothStepInterp</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0-2.0</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// rough approximation of pow(x,y)</span>
<span class="w">    </span><span class="kt">double</span>
<span class="w">    </span><span class="nf">powFast</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// accel/decel curve (a &lt; 0 =&gt; decel)</span>
<span class="w">    </span><span class="kt">double</span>
<span class="w">    </span><span class="nf">accelerationInterp</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="o">?</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="o">?</span><span class="w"> </span><span class="n">powFast</span><span class="p">(</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">powFast</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// normalized linear intep</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DVEC3</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">nlerp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DVEC3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DVEC3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="n">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="n">bm</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// linear interp</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DVEC3</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">lerp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DVEC3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DVEC3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DMAT4</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">getTrans</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DMAT4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DMAT4</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">getXAxis</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DMAT4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DMAT4</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">getYAxis</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DMAT4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DMAT4</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">getZAxis</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DMAT4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DURATION</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">to_seconds</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DURATION</span><span class="o">&amp;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">1e-9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">temp</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">DMAT4</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">DMAT4</span><span class="w"> </span><span class="n">extract_rotation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DMAT4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DMAT4</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">        </span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">computeWorld</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// TODO</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">normalizeAzimRad</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">M_PI</span><span class="p">)</span>
<span class="w">            </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmod</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">M_PI</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">M_PI</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">M_PI</span><span class="o">*</span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">M_PI</span><span class="o">*</span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">put</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ROCKY_SOFT_ASSERT_AND_RETURN</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="p">());</span>
<span class="w">    </span><span class="n">object</span><span class="o">-&gt;</span><span class="n">setObject</span><span class="p">(</span><span class="s">&quot;rocky.mapmanipulator&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">MapManipulator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">MapManipulator</span><span class="o">&gt;</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">object</span><span class="o">-&gt;</span><span class="n">getRefObject</span><span class="o">&lt;</span><span class="n">MapManipulator</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;rocky.mapmanipulator&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>


<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">Action</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="n">_type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span>
<span class="w">    </span><span class="n">_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">init</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">Action</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="n">_type</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">init</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">init</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_dir</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_PAN_LEFT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ROTATE_LEFT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_LEFT</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_PAN_RIGHT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ROTATE_RIGHT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_RIGHT</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_PAN_UP</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ROTATE_UP</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ZOOM_IN</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_UP</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_PAN_DOWN</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ROTATE_DOWN</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_ZOOM_OUT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_DOWN</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">DIR_NA</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">Action</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">    </span><span class="n">_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_type</span><span class="p">),</span>
<span class="w">    </span><span class="n">_dir</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_dir</span><span class="p">),</span>
<span class="w">    </span><span class="n">_options</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//nop</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">getBoolOption</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">_options</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">option</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">boolValue</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">getIntOption</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">_options</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">option</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">intValue</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">::</span><span class="n">getDoubleOption</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">_options</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">option</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">doubleValue</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="w"> </span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">NullAction</span><span class="p">(</span><span class="w"> </span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">ACTION_NULL</span><span class="w"> </span><span class="p">);</span>

<span class="k">namespace</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s_actionNames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;null&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;home&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;goto&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;pan&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;pan-left&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;pan-right&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;pan-up&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;pan-down&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rotate&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rotate-left&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rotate-right&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rotate-up&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;rotate-down&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;zoom&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;zoom-in&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;zoom-out&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;earth-drag&quot;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s_actionOptionNames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;scale-x&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;scale-y&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;continuous&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;single-axis&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;goto-range-factor&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;duration&quot;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">s_actionOptionTypes</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// 0=bool, 1=double</span>
<span class="p">}</span>

<span class="c1">//------------------------------------------------------------------------</span>


<span class="n">MapManipulator</span><span class="o">::</span><span class="n">InputSpec</span><span class="o">::</span><span class="n">InputSpec</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">input_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">_event_type</span><span class="p">(</span><span class="n">event_type</span><span class="p">),</span><span class="w"> </span><span class="n">_input_mask</span><span class="p">(</span><span class="n">input_mask</span><span class="p">),</span><span class="w"> </span><span class="n">_modkey_mask</span><span class="p">(</span><span class="n">modkey_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="n">MapManipulator</span><span class="o">::</span><span class="n">InputSpec</span><span class="o">::</span><span class="n">InputSpec</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">InputSpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">_event_type</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_event_type</span><span class="p">),</span><span class="w"> </span><span class="n">_input_mask</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_input_mask</span><span class="p">),</span><span class="w"> </span><span class="n">_modkey_mask</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_modkey_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">InputSpec</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">InputSpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">        </span><span class="n">_event_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_event_type</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">_input_mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_input_mask</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">((</span><span class="n">_modkey_mask</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_NumLock</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">_modkey_mask</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_NumLock</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">InputSpec</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">InputSpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_event_type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_event_type</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_event_type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_event_type</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_input_mask</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_input_mask</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_input_mask</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_input_mask</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">_modkey_mask</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">_modkey_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define HASMODKEY( W, V ) (( W &amp; V ) == V )</span>

<span class="c1">// expands one input spec into many if necessary, to deal with modifier key combos.</span>
<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">expandSpec</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">InputSpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">InputSpecs</span><span class="o">&amp;</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">_event_type</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">_input_mask</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">_modkey_mask</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HASMODKEY</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Control_L), output);</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Control_R), output);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HASMODKEY</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Alt</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Alt_L), output);</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Alt_R), output);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HASMODKEY</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Shift</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Shift_L), output);</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Shift_R), output);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HASMODKEY</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Meta</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Meta_L), output);</span>
<span class="w">        </span><span class="c1">//expandSpec(InputSpec(e, i, m &amp; ~vsg::KEY_Meta_R), output);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//Always add the input so if we are dealing with a windowing system like QT that just sends MODKEY_CTRL it will still work.</span>
<span class="w">    </span><span class="n">output</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">InputSpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">spec</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">InputSpecs</span><span class="w"> </span><span class="n">specs</span><span class="p">;</span>
<span class="w">    </span><span class="n">expandSpec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="w"> </span><span class="n">specs</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">specs</span><span class="p">)</span>
<span class="w">        </span><span class="n">_bindings</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">actionType</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">EVENT_MOUSE_DRAG</span><span class="p">,</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">actionType</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindMouseClick</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">EVENT_MOUSE_CLICK</span><span class="p">,</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindMouseDoubleClick</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">EVENT_MOUSE_DOUBLE_CLICK</span><span class="p">,</span><span class="w"> </span><span class="n">button_mask</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">EVENT_KEY_DOWN</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindScroll</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scrolling_direction</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">EVENT_SCROLL</span><span class="p">,</span><span class="w"> </span><span class="n">scrolling_direction</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindPinch</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">EVENT_MULTI_PINCH</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindTwist</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">EVENT_MULTI_TWIST</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">bindMultiDrag</span><span class="p">(</span><span class="n">ActionType</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ActionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">InputSpec</span><span class="p">(</span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">EVENT_MULTI_DRAG</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">MapManipulator</span><span class="o">::</span><span class="n">Action</span><span class="o">&amp;</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">Settings</span><span class="o">::</span><span class="n">getAction</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">input_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">modkey_mask</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//Build the input spec but remove the numlock and caps lock from the modkey mask.  On Linux these seem to be passed in as part of the modkeymask</span>
<span class="w">    </span><span class="c1">//if they are on.  So if you bind an action like SCROLL to a modkey mask of 0 or a modkey mask of ctrl it will never match the spec exactly b/c</span>
<span class="w">    </span><span class="c1">//the modkey mask also includes capslock and numlock.</span>
<span class="w">    </span><span class="n">InputSpec</span><span class="w"> </span><span class="nf">spec</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="n">input_mask</span><span class="p">,</span><span class="w"> </span><span class="n">modkey_mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_NumLock</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_CapsLock</span><span class="p">);</span>
<span class="w">    </span><span class="n">ActionBindings</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bindings</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">_bindings</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">i</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NullAction</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************/</span>

<span class="n">MapManipulator</span><span class="o">::</span><span class="n">MapManipulator</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">MapNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mapNode</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Window</span><span class="o">&gt;</span><span class="w"> </span><span class="n">window</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Camera</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera</span><span class="p">,</span><span class="w"> </span><span class="n">VSGContext</span><span class="o">&amp;</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>

<span class="w">    </span><span class="n">Inherit</span><span class="p">(),</span>
<span class="w">    </span><span class="n">_mapNode_weakptr</span><span class="p">(</span><span class="n">mapNode</span><span class="p">),</span>
<span class="w">    </span><span class="n">_window_weakptr</span><span class="p">(</span><span class="n">window</span><span class="p">),</span>
<span class="w">    </span><span class="n">_camera_weakptr</span><span class="p">(</span><span class="n">camera</span><span class="p">),</span>
<span class="w">    </span><span class="n">_context</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
<span class="w">    </span><span class="n">_lastAction</span><span class="p">(</span><span class="n">ACTION_NULL</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">reinitialize</span><span class="p">();</span>
<span class="w">    </span><span class="n">configureDefaultSettings</span><span class="p">();</span>
<span class="w">    </span><span class="n">home</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MapManipulator</span><span class="o">::~</span><span class="n">MapManipulator</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//nop</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">configureDefaultSettings</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Settings</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// install default action bindings:</span>
<span class="w">    </span><span class="n">ActionOptions</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>

<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ACTION_HOME</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">KEY_Space</span><span class="p">);</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">OPTION_CONTINUOUS</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// zoom as you hold the right button:</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ZOOM</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_RIGHT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ZOOM</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_RIGHT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_PAN</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_PAN</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// rotate with either the middle button or the left+right buttons:</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_MIDDLE_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MOUSE_RIGHT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_MIDDLE_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouse</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MOUSE_RIGHT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">OPTION_SCALE_X</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">OPTION_SCALE_Y</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// zoom with the scroll wheel:</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindScroll</span><span class="p">(</span><span class="n">ACTION_ZOOM_IN</span><span class="p">,</span><span class="w"> </span><span class="n">DIR_UP</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindScroll</span><span class="p">(</span><span class="n">ACTION_ZOOM_OUT</span><span class="p">,</span><span class="w"> </span><span class="n">DIR_DOWN</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// pan around with arrow keys:</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ACTION_PAN_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">KEY_Left</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ACTION_PAN_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">KEY_Right</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ACTION_PAN_UP</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">KEY_Up</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">ACTION_PAN_DOWN</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">KEY_Down</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// double click the left button to zoom in on a point:</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">OPTION_GOTO_RANGE_FACTOR</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouseDoubleClick</span><span class="p">(</span><span class="n">ACTION_GOTO</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// double click the right button (or CTRL-left button) to zoom out to a point</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">OPTION_GOTO_RANGE_FACTOR</span><span class="p">,</span><span class="w"> </span><span class="mf">2.5</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouseDoubleClick</span><span class="p">(</span><span class="n">ACTION_GOTO</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_RIGHT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMouseDoubleClick</span><span class="p">(</span><span class="n">ACTION_GOTO</span><span class="p">,</span><span class="w"> </span><span class="n">MOUSE_LEFT_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MODKEY_Control</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// map multi-touch pinch to a discrete zoom</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindPinch</span><span class="p">(</span><span class="n">ACTION_ZOOM</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindTwist</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">bindMultiDrag</span><span class="p">(</span><span class="n">ACTION_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>

<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">lockAzimuthWhilePanning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">settings</span><span class="p">.</span><span class="n">zoomToMouse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">dirty</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TASK_NONE</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// apply new pitch restrictions</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">old_pitch_rad</span><span class="p">;</span>
<span class="w">    </span><span class="n">getEulerAngles</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_pitch_rad</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">old_pitch_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">degrees</span><span class="p">(</span><span class="n">old_pitch_rad</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">new_pitch_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">old_pitch_deg</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">minPitch</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">maxPitch</span><span class="p">);</span>

<span class="w">    </span><span class="n">setDistance</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">reinitialize</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="p">();</span>
<span class="w">    </span><span class="n">_thrown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">_delta</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">_throwDelta</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">_continuousDelta</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">_continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">_lastAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ACTION_NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">_previousMove</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">clearEvents</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">createLocalCoordFrame</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">worldPos</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dmat4</span><span class="o">&amp;</span><span class="w"> </span><span class="n">out_frame</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">out_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">topocentricToWorldMatrix</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">worldPos</span><span class="p">)));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">setCenter</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">worldPos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">dmat4</span><span class="w"> </span><span class="n">new_topo_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">topocentricToWorldMatrix</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">worldPos</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">lockAzimuthWhilePanning</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// remove the translation component</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">new_topo_frame</span><span class="p">);</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">dquat</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">),</span><span class="w"> </span><span class="n">to_glm</span><span class="p">(</span><span class="n">worldPos</span><span class="p">));</span>
<span class="w">            </span><span class="n">glm</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">quat_cast</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">));</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4_cast</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">old</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">worldPos</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">vsg</span><span class="o">::</span><span class="n">dmat4</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">getWorldLookAtMatrix</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//The look vector will be going directly from the eye point to the point on the earth,</span>
<span class="w">    </span><span class="c1">//so the look vector is simply the up vector at the center point</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dmat4</span><span class="w"> </span><span class="n">cf</span><span class="p">;</span>
<span class="w">    </span><span class="n">createLocalCoordFrame</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">cf</span><span class="p">);</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">lookVector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">getZAxis</span><span class="p">(</span><span class="n">cf</span><span class="p">);</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">side</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//Force the side vector to be orthogonal to north</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">worldUp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">worldUp</span><span class="p">,</span><span class="w"> </span><span class="n">lookVector</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">epsilonEqual</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//We are looking nearly straight down the up vector, so use the Y vector for world up instead</span>
<span class="w">        </span><span class="n">worldUp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">cross</span><span class="p">(</span><span class="n">lookVector</span><span class="p">,</span><span class="w"> </span><span class="n">worldUp</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">cross</span><span class="p">(</span><span class="n">side</span><span class="p">,</span><span class="w"> </span><span class="n">lookVector</span><span class="p">);</span>
<span class="w">    </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//We want a very slight offset</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">lookAt</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">lookVector</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">offset</span><span class="p">),</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 1</span>
<span class="n">Viewpoint</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">viewpoint</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Viewpoint</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>

<span class="cp">#if 0</span>
<span class="c">    // Tethering? Use the tether viewpoint.</span>
<span class="c">    if ( isTethering() &amp;&amp; _setVP1.has_value() )</span>
<span class="c">    {</span>
<span class="c">        vp = _setVP1.get();</span>

<span class="c">        if (vp.node)</span>
<span class="c">            vp.focalPoint-&gt;fromWorld(_srs.get(), computeWorld(vp.node));</span>
<span class="c">        else</span>
<span class="c">            vp.focalPoint.unset();</span>
<span class="c">    }</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// the focal point:</span>
<span class="w">    </span><span class="n">vp</span><span class="p">.</span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GeoPoint</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">(),</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Always update the local offsets.</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">localAzim</span><span class="p">,</span><span class="w"> </span><span class="n">localPitch</span><span class="p">;</span>
<span class="w">    </span><span class="n">getEulerAngles</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localAzim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localPitch</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">vp</span><span class="p">.</span><span class="n">heading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="n">localAzim</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">DEGREES</span><span class="p">);</span>
<span class="w">    </span><span class="n">vp</span><span class="p">.</span><span class="n">pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="n">localPitch</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">DEGREES</span><span class="p">);</span>
<span class="w">    </span><span class="n">vp</span><span class="p">.</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">vp</span><span class="p">.</span><span class="n">positionOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_glm</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">setViewpoint</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Viewpoint</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">setViewpoint</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">setViewpoint</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Viewpoint</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vp</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span>
<span class="c">    // Save any existing tether node so we can properly invoke the callback.</span>
<span class="c">    osg::ref_ptr&lt;vsg::Node&gt; oldEndNode;</span>
<span class="c">    if (isTethering() &amp;&amp; _tetherCallback.valid())</span>
<span class="c">    {</span>
<span class="c">        oldEndNode = _setVP1-&gt;getNode();</span>
<span class="c">    }</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// starting viewpoint; all fields will be set:</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewpoint</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ending viewpoint</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Reset the tethering offset quat.</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotationVP0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotation</span><span class="p">;</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotationVP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Fill in any missing end-point data with defaults matching the current camera setup.</span>
<span class="w">    </span><span class="c1">// Then all fields are guaranteed to contain usable data during transition.</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">defPitch</span><span class="p">,</span><span class="w"> </span><span class="n">defAzim</span><span class="p">;</span>
<span class="w">    </span><span class="n">getEulerAngles</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">defAzim</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">defPitch</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">heading</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">heading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="n">defAzim</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="n">defPitch</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Distance</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">duration_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPDuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration_seconds</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Timed transition, we need to calculate some things:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Start point is the current manipulator center:</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">startWorld</span><span class="p">;</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">startNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"> </span><span class="c1">// _setVP0-&gt;getNode();</span>
<span class="w">        </span><span class="n">startWorld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">);</span><span class="w"> </span><span class="c1">// startNode ? computeWorld(startNode) : _center;</span>

<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPStartTime</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// End point is the world coordinates of the target viewpoint:</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">world_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">().</span><span class="n">transform</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">());</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">endWorld</span><span class="p">(</span><span class="n">world_pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">world_pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">world_pos</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// calculate an acceleration factor based on the Z differential.</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">range0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">range1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">);</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">pitch0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">pitch1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">h0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">pitch0</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">pitch1</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// calculate the total distance the focal point will travel and derive an arc height:</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">endWorld</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startWorld</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// maximum height during viewpoint transition</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">arcViewpoints</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">de</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">dh</span><span class="p">),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// calculate acceleration coefficients</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// if we&#39;re arcing, we need separate coefficients for the up and down stages</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">h_apex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">h0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="p">;</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">dh2_up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">h_apex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100000.0</span><span class="p">;</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">dh2_up</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">dh2_down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">h_apex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100000.0</span><span class="p">;</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPAccel2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">log10</span><span class="p">(</span><span class="n">dh2_down</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// on arc =&gt; simple unidirectional acceleration:</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">dh2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100000.0</span><span class="p">;</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">dh2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dh2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">dh2</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">dh2</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVPAccel</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="cp">#if 0</span>
<span class="c">        // Adjust the duration if necessary.</span>
<span class="c">        if (settings.getAutoViewpointDurationEnabled())</span>
<span class="c">        {</span>
<span class="c">            double maxDistance = _worldSRS.ellipsoid().semiMajorAxis();</span>
<span class="c">            double ratio = clamp(de / maxDistance, 0.0, 1.0);</span>
<span class="c">            ratio = accelerationInterp(ratio, -4.5);</span>
<span class="c">            double minDur, maxDur;</span>
<span class="c">            settings.getAutoViewpointDurationLimits(minDur, maxDur);</span>
<span class="c">            _state.setVPDuration.set(minDur + ratio * (maxDur - minDur), Units::SECONDS);</span>
<span class="c">        }</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Immediate transition? Just do it now.</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_previousTime</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//_state.setVPStartTime-&gt;set( _time_s_now, Units::SECONDS );</span>
<span class="w">        </span><span class="n">setViewpointFrame</span><span class="p">(</span><span class="n">_previousTime</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#if 0</span>
<span class="c">    // Fire a tether callback if required.</span>
<span class="c">    if (_tetherCallback.valid())</span>
<span class="c">    {</span>
<span class="c">        // starting a tether to a NEW node:</span>
<span class="c">        if (isTethering() &amp;&amp; oldEndNode.get() != endNode.get())</span>
<span class="c">            (*_tetherCallback)(endNode.get());</span>

<span class="c">        // breaking a tether:</span>
<span class="c">        else if (!isTethering() &amp;&amp; oldEndNode.valid())</span>
<span class="c">            (*_tetherCallback)(0L);</span>
<span class="c">    }</span>
<span class="cp">#endif</span>


<span class="w">    </span><span class="c1">// reset other global state flags.</span>
<span class="w">    </span><span class="n">_thrown</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TASK_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// returns &quot;t&quot; [0..1], the interpolation coefficient.</span>
<span class="kt">double</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">setViewpointFrame</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="o">&amp;</span><span class="w"> </span><span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">_state</span><span class="p">.</span><span class="n">setVPStartTime</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Start point is the current manipulator center:</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">().</span><span class="n">transform</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">());</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">startWorld</span><span class="p">(</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">p0</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// End point is the world coordinates of the target viewpoint:</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">().</span><span class="n">transform</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">());</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">endWorld</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Remaining time is the full duration minus the time since initiation:</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPStartTime</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPDuration</span><span class="p">;</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">elapsed</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">tp</span><span class="p">;</span>
<span class="w">                </span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">t2</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">tp</span><span class="mf">-0.5</span><span class="p">);</span>
<span class="w">                </span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">+</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">t2</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// the more smoothsteps you do, the more pronounced the fade-in/out effect</span>
<span class="w">            </span><span class="n">smoothStepInterp</span><span class="p">(</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smoothStepInterp</span><span class="p">(</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">newCenter</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">nlerp</span><span class="p">(</span><span class="n">startWorld</span><span class="p">,</span><span class="w"> </span><span class="n">endWorld</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<span class="w">            </span><span class="n">lerp</span><span class="p">(</span><span class="n">startWorld</span><span class="p">,</span><span class="w"> </span><span class="n">endWorld</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Calculate the delta-heading, and make sure we are going in the shortest direction:</span>
<span class="w">        </span><span class="n">Angle</span><span class="w"> </span><span class="n">d_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">heading</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">heading</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">d_azim</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="n">d_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_azim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">M_PI</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">d_azim</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">M_PI</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="n">d_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_azim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Angle</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">M_PI</span><span class="p">,</span><span class="w"> </span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">newAzim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">heading</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tp</span><span class="o">*</span><span class="n">d_azim</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Calculate the new pitch:</span>
<span class="w">        </span><span class="n">Angle</span><span class="w"> </span><span class="n">d_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">newPitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tp</span><span class="o">*</span><span class="n">d_pitch</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">RADIANS</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Calculate the new range:</span>
<span class="w">        </span><span class="n">Distance</span><span class="w"> </span><span class="n">d_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">newRange</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">d_range</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Units</span><span class="o">::</span><span class="n">METERS</span><span class="p">)</span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">M_PI</span><span class="o">*</span><span class="n">tp</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVPArcHeight</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Calculate the offsets</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">offset0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="o">-&gt;</span><span class="n">positionOffset</span><span class="p">.</span><span class="n">value_or</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">}));</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">positionOffset</span><span class="p">.</span><span class="n">value_or</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">}));</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">newOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">offset1</span><span class="o">-</span><span class="n">offset0</span><span class="p">)</span><span class="o">*</span><span class="n">tp</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Activate.</span>
<span class="w">        </span><span class="c1">//setLookAt(newCenter, newAzim, newPitch, newRange, newOffset);</span>
<span class="w">        </span><span class="n">setCenter</span><span class="p">(</span><span class="n">newCenter</span><span class="p">);</span>
<span class="w">        </span><span class="n">setDistance</span><span class="p">(</span><span class="n">newRange</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//_state.center = newCenter;</span>
<span class="w">        </span><span class="c1">//_state.distance = newRange;</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getQuaternion</span><span class="p">(</span><span class="n">newAzim</span><span class="p">,</span><span class="w"> </span><span class="n">newPitch</span><span class="p">);</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newOffset</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// interpolate tether rotation:</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">mix</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotationVP0</span><span class="p">,</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotationVP1</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// At t=1 the transition is complete.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// If this was a transition into a tether, keep the endpoint around so we can</span>
<span class="w">            </span><span class="c1">// continue tracking it.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">isTethering</span><span class="p">()</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">clearViewpoint</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Cancel any ongoing transition or tethering:</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">recalculateCenterAndDistanceFromLookVector</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">home</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#if 0</span>
<span class="c">    // Fire the callback to indicate a tethering break.</span>
<span class="c">    if ( _tetherCallback.valid() &amp;&amp; breakingTether )</span>
<span class="c">        (*_tetherCallback)( 0L );</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">MapNode</span><span class="o">&gt;</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">getMapNode</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_mapNode_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">out_intersection</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// clamp the end point to a plane centered on the Earth with the normal vector</span>
<span class="w">            </span><span class="c1">// pointing along the start-&gt;end direction.</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">Q</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">((</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Q</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">LineSegmentIntersector</span><span class="w"> </span><span class="n">lsi</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>

<span class="w">        </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">terrainNode</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">lsi</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span>
<span class="w">                </span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="w">                </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>

<span class="w">            </span><span class="n">out_intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closest</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">worldIntersection</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">intersectAlongLookVector</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">out_world</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="w"> </span><span class="n">lookat</span><span class="p">;</span>
<span class="w">        </span><span class="n">lookat</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">_viewMatrix</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">intersect</span><span class="p">(</span>
<span class="w">            </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
<span class="w">            </span><span class="n">out_world</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">home</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// emulate clearViewpoint() without calling it (possible recursion)</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP0</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">reinitialize</span><span class="p">();</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">ellipsoid</span><span class="p">().</span><span class="n">semiMajorAxis</span><span class="p">();</span>
<span class="w">        </span><span class="n">setCenter</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">bounds</span><span class="p">().</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">        </span><span class="n">setCenter</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// reset rotation:</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">topo_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">topocentricToWorldMatrix</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">));</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">topo_frame</span><span class="p">);</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">setDistance</span><span class="p">(</span><span class="n">radius</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3.5</span><span class="p">);</span>

<span class="w">    </span><span class="n">clearEvents</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">clearEvents</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">_keyPress</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Note: never clear the _previousMove event!</span>
<span class="w">    </span><span class="n">_task</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">KeyPressEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">keyPress</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keyPress</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">withinRenderArea</span><span class="p">(</span><span class="n">_previousMove</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">_keyPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPress</span><span class="p">;</span>

<span class="w">    </span><span class="n">recalculateCenterAndDistanceFromLookVector</span><span class="p">();</span>

<span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;KeyPressEvent&quot; &lt;&lt; std::endl;</span>

<span class="w">    </span><span class="n">_lastAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getAction</span><span class="p">(</span>
<span class="w">        </span><span class="n">EVENT_KEY_DOWN</span><span class="p">,</span>
<span class="w">        </span><span class="n">keyPress</span><span class="p">.</span><span class="n">keyBase</span><span class="p">,</span>
<span class="w">        </span><span class="n">keyPress</span><span class="p">.</span><span class="n">keyModifier</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handleKeyboardAction</span><span class="p">(</span><span class="n">_lastAction</span><span class="p">,</span><span class="w"> </span><span class="n">keyPress</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">keyPress</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">KeyReleaseEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">keyRelease</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;KeyReleaseEvent&quot; &lt;&lt; std::endl;</span>

<span class="w">    </span><span class="n">_keyPress</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ButtonPressEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buttonPress</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buttonPress</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">withinRenderArea</span><span class="p">(</span><span class="n">buttonPress</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;ButtonPressEvent&quot; &lt;&lt; std::endl;</span>

<span class="w">    </span><span class="c1">// simply record the button press event.</span>
<span class="w">    </span><span class="n">clearEvents</span><span class="p">();</span>

<span class="w">    </span><span class="n">_buttonPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buttonPress</span><span class="p">;</span>

<span class="w">    </span><span class="n">recalculateCenterAndDistanceFromLookVector</span><span class="p">();</span>

<span class="w">    </span><span class="n">buttonPress</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ButtonReleaseEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;ButtonReleaseEvent&quot; &lt;&lt; std::endl;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isMouseClick</span><span class="p">(</span><span class="n">buttonRelease</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_lastAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">EVENT_MOUSE_CLICK</span><span class="p">,</span>
<span class="w">            </span><span class="n">_buttonPress</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">,</span>
<span class="w">            </span><span class="n">_buttonPress</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handlePointAction</span><span class="p">(</span><span class="n">_lastAction</span><span class="p">,</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">time</span><span class="p">))</span>
<span class="w">            </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">world</span><span class="p">;</span>
<span class="w">        </span><span class="n">viewportToWorld</span><span class="p">(</span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">clearEvents</span><span class="p">();</span>

<span class="w">    </span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">MoveEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Note: always record the move event (into _previousMove) regardless</span>
<span class="w">    </span><span class="c1">// of whether we process the new move event.</span>

<span class="w">    </span><span class="c1">// If there&#39;s no button press, bail out.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_previousMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">;</span>
<span class="w">        </span><span class="n">moveEvent</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check if the button got released outside the window (and did not generate an event)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">moveEvent</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_previousMove</span><span class="o">-&gt;</span><span class="n">mask</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_previousMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">;</span>
<span class="w">        </span><span class="n">clearEvents</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Good to go, process the move:</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Window</span><span class="o">&gt;</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">.</span><span class="n">window</span><span class="p">;</span>

<span class="w">    </span><span class="n">_lastAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getAction</span><span class="p">(</span>
<span class="w">        </span><span class="n">EVENT_MOUSE_DRAG</span><span class="p">,</span>
<span class="w">        </span><span class="n">moveEvent</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="c1">// button mask</span>
<span class="w">        </span><span class="n">_keyPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_keyPress</span><span class="o">-&gt;</span><span class="n">keyModifier</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">wasContinuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_continuous</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_lastAction</span><span class="p">.</span><span class="n">getBoolOption</span><span class="p">(</span><span class="n">OPTION_CONTINUOUS</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span>
<span class="w">        </span><span class="o">++</span><span class="n">_continuous</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">_continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handleMouseAction</span><span class="p">(</span><span class="n">_lastAction</span><span class="p">,</span><span class="w"> </span><span class="n">_previousMove</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">))</span>
<span class="w">        </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_continuous</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// &amp;&amp; !wasContinuous)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_continuousAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_lastAction</span><span class="p">;</span>
<span class="w">        </span><span class="n">_context</span><span class="o">-&gt;</span><span class="n">requestFrame</span><span class="p">();</span>
<span class="w">        </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">_thrown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">moveEvent</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">_previousMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moveEvent</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ScrollWheelEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">scrollEvent</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">handled</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">withinRenderArea</span><span class="p">(</span><span class="n">_previousMove</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//std::cout &lt;&lt; &quot;ScrollWheelEvent&quot; &lt;&lt; std::endl;</span>

<span class="w">    </span><span class="n">Direction</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">delta</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_LEFT</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">delta</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_RIGHT</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">delta</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_UP</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">delta</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIR_DOWN</span><span class="w"> </span><span class="o">:</span>
<span class="w">        </span><span class="n">DIR_NA</span><span class="p">;</span>

<span class="w">    </span><span class="n">_lastAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">getAction</span><span class="p">(</span>
<span class="w">        </span><span class="n">EVENT_SCROLL</span><span class="p">,</span>
<span class="w">        </span><span class="n">dir</span><span class="p">,</span>
<span class="w">        </span><span class="n">_keyPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_keyPress</span><span class="o">-&gt;</span><span class="n">keyModifier</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">handleScrollAction</span><span class="p">(</span>
<span class="w">        </span><span class="n">_lastAction</span><span class="p">,</span>
<span class="w">        </span><span class="n">scrollEvent</span><span class="p">.</span><span class="n">time</span><span class="p">,</span>
<span class="w">        </span><span class="n">_lastAction</span><span class="p">.</span><span class="n">getDoubleOption</span><span class="p">(</span><span class="n">OPTION_DURATION</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">TouchDownEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">touchDown</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NOT_YET_IMPLEMENTED</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">TouchUpEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">touchUp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NOT_YET_IMPLEMENTED</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">TouchMoveEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">touchMove</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NOT_YET_IMPLEMENTED</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">FrameEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//Log()-&gt;warn(util::make_string() &lt;&lt; &quot;FrameEvent-------------------------- &quot; &lt;&lt; frame.time.time_since_epoch().count());</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_continuous</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// start requesting frame draws:</span>
<span class="w">        </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_continuous</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// wait one frame before updating the continuous movement,</span>
<span class="w">            </span><span class="c1">// becuase the first one (in on-demand mode) will have a bogus time delta</span>
<span class="w">            </span><span class="c1">// which will cause a jump.</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">t_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_seconds</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_previousTime</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60.0</span><span class="p">;</span>
<span class="w">            </span><span class="n">handleMovementAction</span><span class="p">(</span><span class="n">_continuousAction</span><span class="p">.</span><span class="n">_type</span><span class="p">,</span><span class="w"> </span><span class="n">_continuousDelta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t_factor</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_continuousDelta</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">serviceTask</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isSettingViewpoint</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">setViewpointFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isTethering</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">updateTether</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">camera_changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateCamera</span><span class="p">();</span>

<span class="w">    </span><span class="n">_previousTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// if anything caused the camera&#39;s matrix to change, dirty the instance to</span>
<span class="w">    </span><span class="c1">// request a new frame.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">camera_changed</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">_dirty</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_context</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">_context</span><span class="o">-&gt;</span><span class="n">requestFrame</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">updateCamera</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">oldMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_viewMatrix</span><span class="p">;</span>

<span class="w">        </span><span class="n">_viewMatrix</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="w"> </span><span class="o">*</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localPositionOffset</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">tetherRotation</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">lookat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lookat</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">lookat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="o">::</span><span class="n">create</span><span class="p">();</span>
<span class="w">            </span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookat</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">lookat</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">_viewMatrix</span><span class="p">);</span>

<span class="w">        </span><span class="n">changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldMatrix</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">_viewMatrix</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">serviceTask</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TASK_NONE</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// delay the servicing by one frame to prevent jumps in on-demand mode</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_task</span><span class="p">.</span><span class="n">_frameCount</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_seconds</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_previousTime</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// cap the DT so we don&#39;t exceed the expected delta.</span>
<span class="w">                </span><span class="c1">//dt = std::min(dt, _task._duration_s);</span>

<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_task</span><span class="p">.</span><span class="n">_delta</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_task</span><span class="p">.</span><span class="n">_delta</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>

<span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">TASK_PAN</span><span class="p">:</span>
<span class="w">                    </span><span class="n">pan</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">TASK_ROTATE</span><span class="p">:</span>
<span class="w">                    </span><span class="n">rotate</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">TASK_ZOOM</span><span class="p">:</span>
<span class="w">                    </span><span class="n">zoom</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">_task</span><span class="p">.</span><span class="n">_duration_s</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_task</span><span class="p">.</span><span class="n">_duration_s</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TASK_NONE</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// returns true if the task is still running.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_task</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TASK_NONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">isMouseClick</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">ButtonReleaseEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buttonRelease</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span><span class="w"> </span><span class="c1">// || !_buttonRelease.has_value())</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndc</span><span class="p">(</span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndc</span><span class="p">(</span><span class="n">buttonRelease</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">down</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">down</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dtmillis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buttonRelease</span><span class="p">.</span><span class="n">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_buttonPress</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">dtmillis</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.001f</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dt</span><span class="o">*</span><span class="w"> </span><span class="n">velocity</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">recalculateCenterFromLookVector</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="w"> </span><span class="n">lookat</span><span class="p">;</span>
<span class="w">    </span><span class="n">lookat</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="o">-&gt;</span><span class="n">inverse</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">);</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">intersection</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intersectAlongLookVector</span><span class="p">(</span><span class="n">intersection</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intersect</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">,</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">intersection</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// backup plan, intersect the ellipsoid or the ground plane</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e10</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">ellipsoid</span><span class="p">().</span><span class="n">intersectGeocentricLine</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">),</span><span class="w"> </span><span class="n">to_glm</span><span class="p">(</span><span class="n">target</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">            </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// simple line/plane intersection</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">P0</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// point on the plane</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// normal to the plane</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">look</span><span class="p">;</span><span class="w"> </span><span class="c1">// unit direction of the line</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">;</span><span class="w"> </span><span class="c1">// point on the line</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">LdotN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">epsilonEqual</span><span class="p">(</span><span class="n">LdotN</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// parallel</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">((</span><span class="n">P0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L0</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">LdotN</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">D</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// behind the camera</span>
<span class="w">        </span><span class="n">intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
<span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// keep the existing center, but change its length</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">intersection</span><span class="p">);</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">setCenter</span><span class="p">(</span><span class="n">intersection</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">recalculateCenterAndDistanceFromLookVector</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="w"> </span><span class="n">lookat</span><span class="p">;</span>
<span class="w">    </span><span class="n">lookat</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="o">-&gt;</span><span class="n">inverse</span><span class="p">());</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">);</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">intersection</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intersect</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">,</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="n">intersection</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// backup plan, intersect the ellipsoid or the ground plane</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e10</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">ellipsoid</span><span class="p">().</span><span class="n">intersectGeocentricLine</span><span class="p">(</span><span class="n">to_glm</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">),</span><span class="w"> </span><span class="n">to_glm</span><span class="p">(</span><span class="n">target</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_vsg</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">            </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// simple line/plane intersection</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">P0</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// point on the plane</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// normal to the plane</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">look</span><span class="p">;</span><span class="w"> </span><span class="c1">// unit direction of the line</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">;</span><span class="w"> </span><span class="c1">// point on the line</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">LdotN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">epsilonEqual</span><span class="p">(</span><span class="n">LdotN</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// parallel</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">((</span><span class="n">P0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">L0</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">LdotN</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">D</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// behind the camera</span>
<span class="w">        </span><span class="n">intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
<span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">setCenter</span><span class="p">(</span><span class="n">intersection</span><span class="p">);</span>
<span class="w">        </span><span class="n">setDistance</span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">intersection</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">pan</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// to pan, we need a focus point on the terrain:</span>
<span class="w">    </span><span class="c1">//if ( !recalculateCenterFromLookVector() )</span>
<span class="w">    </span><span class="c1">//    return;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-0.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// the view-space coordinate frame:</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">lookat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">viewMatrix</span><span class="o">-&gt;</span><span class="n">inverse</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">x_axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">getXAxis</span><span class="p">(</span><span class="n">lookat</span><span class="p">));</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">y_axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">getZAxis</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">),</span><span class="w"> </span><span class="n">x_axis</span><span class="p">));</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x_axis</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">y_axis</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// save the previous CF so we can do azimuth locking:</span>
<span class="w">    </span><span class="c1">//vsg::dmat4 oldCenterLocalToWorld = _centerReferenceFrame; // _centerLocalToWorld;</span>

<span class="w">    </span><span class="c1">// move the center point</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">old_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">new_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dv</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// in geocentric, ensure that it doesn&#39;t change length.</span>
<span class="w">        </span><span class="n">new_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">new_center</span><span class="p">);</span>
<span class="w">        </span><span class="n">new_center</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">old_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">setCenter</span><span class="p">(</span><span class="n">new_center</span><span class="p">);</span>

<span class="cp">#if 0</span>
<span class="c">        if ( settings.getLockAzimuthWhilePanning() )</span>
<span class="c">        {</span>
<span class="c">            // in azimuth-lock mode, _centerRotation maintains a consistent north vector</span>
<span class="c">            _centerRotation = computeCenterRotation( _center );</span>
<span class="c">        }</span>

<span class="c">        else</span>
<span class="c">        {</span>
<span class="c">            // otherwise, we need to rotate _centerRotation manually.</span>
<span class="c">            vsg::dvec3 new_localUp = getUpVector( _centerLocalToWorld );</span>

<span class="c">            osg::Quat pan_rotation;</span>
<span class="c">            pan_rotation.makeRotate( localUp, new_localUp );</span>

<span class="c">            if ( !pan_rotation.zeroRotation() )</span>
<span class="c">            {</span>
<span class="c">                _centerRotation = _centerRotation * pan_rotation;</span>
<span class="c">                _previousUp = new_localUp;</span>
<span class="c">            }</span>
<span class="c">        }</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span>
<span class="c">    }</span>
<span class="c">    else</span>
<span class="c">    {</span>
<span class="c">    double scale = _distance;</span>

<span class="c">    // Panning in tether mode changes the focal view offsets.</span>
<span class="c">    _viewOffset.x() -= dx * scale;</span>
<span class="c">    _viewOffset.y() -= dy * scale;</span>

<span class="c">    //Clamp values within range</span>
<span class="c">    _viewOffset.x() = clamp(_viewOffset.x(), -settings.getMaxXOffset(), settings.getMaxXOffset());</span>
<span class="c">    _viewOffset.y() = clamp(_viewOffset.y(), -settings.getMaxYOffset(), settings.getMaxYOffset());</span>
<span class="c">    }</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="c1">//collisionDetect();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// clamp the local pitch delta; never allow the pitch to hit -90.</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">radians</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">minPitch</span><span class="p">,</span><span class="w"> </span><span class="mf">-89.9</span><span class="p">));</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">radians</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">maxPitch</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.1</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// clamp pitch range:</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">oldPitch</span><span class="p">;</span>
<span class="w">    </span><span class="n">getEulerAngles</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldPitch</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">oldPitch</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">oldPitch</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dmat4</span><span class="w"> </span><span class="n">rotationFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">tangent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getXAxis</span><span class="p">(</span><span class="n">rotationFrame</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="nf">rotate_elevation</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">tangent</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="nf">rotate_azim</span><span class="p">(</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">);</span>

<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">localRotation</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate_elevation</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate_azim</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//collisionDetect();</span>

<span class="w">    </span><span class="c1">//recalculateCenterAndDistanceFromLookVector();</span>
<span class="p">}</span>

<span class="k">namespace</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// adapted from openscenegraph</span>
<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Q</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="n">slerp</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Q</span><span class="o">&amp;</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Q</span><span class="o">&amp;</span><span class="w"> </span><span class="n">to</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">epsilon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00001</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">omega</span><span class="p">,</span><span class="w"> </span><span class="n">cosomega</span><span class="p">,</span><span class="w"> </span><span class="n">sinomega</span><span class="p">,</span><span class="w"> </span><span class="n">scale_from</span><span class="p">,</span><span class="w"> </span><span class="n">scale_to</span><span class="p">;</span>

<span class="w">        </span><span class="n">Q</span><span class="w"> </span><span class="nf">quatTo</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// this is a dot product</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec4</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">from</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">from</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">        </span><span class="n">glm</span><span class="o">::</span><span class="n">dvec4</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">to</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">to</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">to</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">        </span><span class="n">cosomega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glm</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cosomega</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">cosomega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">cosomega</span><span class="p">;</span>
<span class="w">            </span><span class="n">quatTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">to</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cosomega</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">epsilon</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">omega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acos</span><span class="p">(</span><span class="n">cosomega</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0 &lt;= omega &lt;= Pi (see man acos)</span>
<span class="w">            </span><span class="n">sinomega</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">);</span><span class="w">  </span><span class="c1">// this sinomega should always be +ve so</span>
<span class="w">            </span><span class="c1">// could try sinomega=sqrt(1-cosomega*cosomega) to avoid a sin()?</span>
<span class="w">            </span><span class="n">scale_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">omega</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sinomega</span><span class="p">;</span>
<span class="w">            </span><span class="n">scale_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">omega</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sinomega</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">scale_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">            </span><span class="n">scale_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale_from</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">quatTo</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale_to</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">zoom</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//if (isTethering())</span>
<span class="w">    </span><span class="c1">//{</span>
<span class="w">    </span><span class="c1">//    double scale = 1.0f + dy;</span>
<span class="w">    </span><span class="c1">//    setDistance(_distance * scale);</span>
<span class="w">    </span><span class="c1">//    collisionDetect();</span>
<span class="w">    </span><span class="c1">//    return;</span>
<span class="w">    </span><span class="c1">//}</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">zoomToMouse</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_buttonPress</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">_previousMove</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">_buttonPress</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">_previousMove</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">viewportToWorld</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getMapNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">vsg</span><span class="o">::</span><span class="n">LookAt</span><span class="w"> </span><span class="n">lookat</span><span class="p">;</span>
<span class="w">                </span><span class="n">lookat</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">_viewMatrix</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vsg</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">lookat</span><span class="p">.</span><span class="n">eye</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// don&#39;t zoom if the target is behind the camera</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">//recalculateCenterFromLookVector();</span>

<span class="w">            </span><span class="c1">// Calcuate a rotation that we&#39;ll use to interpolate from our center point to the target</span>
<span class="w">            </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="n">rotCenterToTarget</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Check if the vectors are too close to avoid NaN in quaternion calculation</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">centerMag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">relativeDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">centerMag</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">centerMag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">relativeDist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Use identity quaternion when vectors are nearly identical (relative to their magnitude)</span>
<span class="w">                </span><span class="n">rotCenterToTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">rotCenterToTarget</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Factor by which to scale the distance:</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">newDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">newDistance</span><span class="p">;</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">().</span><span class="n">isGeocentric</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// xform target point into the current focal point&#39;s local frame,</span>
<span class="w">                </span><span class="c1">// and adjust the zoom ratio to account for the difference in</span>
<span class="w">                </span><span class="c1">// target distance based on the earth&#39;s curvature...approximately!</span>
<span class="w">                </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">targetInLocalFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">inverse</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">crRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">targetInLocalFrame</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                </span><span class="n">ratio</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">crRatio</span><span class="p">;</span>

<span class="w">                </span><span class="c1">// Interpolate a new focal point:</span>
<span class="w">                </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="n">rot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slerp</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">rotCenterToTarget</span><span class="p">);</span>
<span class="w">                </span><span class="n">setCenter</span><span class="p">(</span><span class="n">rot</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// linear interp.</span>
<span class="w">                </span><span class="n">setCenter</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">center</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// and set the new zoomed distance.</span>
<span class="w">            </span><span class="n">setDistance</span><span class="p">(</span><span class="n">newDistance</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//recalculateCenterFromLookVector();</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>
<span class="w">    </span><span class="n">setDistance</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">viewportToWorld</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="o">&amp;</span><span class="w"> </span><span class="n">out_world</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">vsg</span><span class="o">::</span><span class="n">Camera</span><span class="o">&gt;</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">LineSegmentIntersector</span><span class="w"> </span><span class="nf">lsi</span><span class="p">(</span><span class="o">*</span><span class="n">camera</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">getMapNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">terrainNode</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">lsi</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span>
<span class="w">        </span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lsi</span><span class="p">.</span><span class="n">intersections</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="w">        </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="n">out_world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closest</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">worldIntersection</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">setDistance</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">distance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_state</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">minDistance</span><span class="p">,</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">maxDistance</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleMovementAction</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ActionType</span><span class="o">&amp;</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN</span><span class="p">:</span>
<span class="w">        </span><span class="n">pan</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// in &quot;single axis&quot; mode, zero out one of the deltas.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_continuous</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">singleAxisRotation</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">::</span><span class="n">fabs</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
<span class="w">                </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">rotate</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ZOOM</span><span class="p">:</span>
<span class="w">        </span><span class="n">zoom</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handlePointAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">mx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">my</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACTION_NULL</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">point</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">viewportToWorld</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span><span class="w"> </span><span class="n">my</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">_type</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_GOTO</span><span class="p">:</span>
<span class="cp">#if 0</span>
<span class="c">            Viewpoint here = getViewpoint();</span>
<span class="c">            here.focalPoint()-&gt;fromWorld(_srs.get(), point);</span>

<span class="c">            double duration_s = action.getDoubleOption(OPTION_DURATION, 1.0);</span>
<span class="c">            double range_factor = action.getDoubleOption(OPTION_GOTO_RANGE_FACTOR, 1.0);</span>

<span class="c">            here.range() = here.range().get() * range_factor;</span>

<span class="c">            setViewpoint(here, duration_s);</span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">applyOptionsToDeltas</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="n">getDoubleOption</span><span class="p">(</span><span class="n">OPTION_SCALE_X</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="n">getDoubleOption</span><span class="p">(</span><span class="n">OPTION_SCALE_Y</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">getBoolOption</span><span class="p">(</span><span class="n">OPTION_SINGLE_AXIS</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
<span class="w">            </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleMouseAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MoveEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">previousMove</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">MoveEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">currentMove</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndc</span><span class="p">(</span><span class="n">currentMove</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_continuous</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_buttonPress</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndc</span><span class="p">(</span><span class="n">_buttonPress</span><span class="p">);</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="nf">delta</span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="w">        </span><span class="n">delta</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">        </span><span class="n">delta</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">mouseSensitivity</span><span class="p">;</span>
<span class="w">        </span><span class="n">applyOptionsToDeltas</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span>
<span class="w">        </span><span class="n">_continuousDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndc</span><span class="p">(</span><span class="n">previousMove</span><span class="p">);</span>
<span class="w">        </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="nf">delta</span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="w">        </span><span class="n">delta</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">mouseSensitivity</span><span class="p">;</span>
<span class="w">        </span><span class="n">applyOptionsToDeltas</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span>
<span class="w">        </span><span class="n">_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">        </span><span class="n">handleMovementAction</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">_type</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleMouseClickAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleKeyboardAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">now</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">_dir</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_LEFT</span><span class="p">:</span><span class="w">  </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_RIGHT</span><span class="p">:</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_UP</span><span class="p">:</span><span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_DOWN</span><span class="p">:</span><span class="w">  </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">keyboardSesitivity</span><span class="p">;</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">keyboardSesitivity</span><span class="p">;</span>

<span class="w">    </span><span class="n">applyOptionsToDeltas</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleScrollAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">scrollFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">_dir</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_LEFT</span><span class="p">:</span><span class="w">  </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_RIGHT</span><span class="p">:</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_UP</span><span class="p">:</span><span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DIR_DOWN</span><span class="p">:</span><span class="w">  </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scrollFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">scrollSensitivity</span><span class="p">;</span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scrollFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">scrollSensitivity</span><span class="p">;</span>

<span class="w">    </span><span class="n">applyOptionsToDeltas</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">handleAction</span><span class="p">(</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">d</span><span class="p">,</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="n">_type</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="cp">#if 0</span>
<span class="c">    case ACTION_HOME:</span>
<span class="c">        if ( _homeViewpoint.has_value() )</span>
<span class="c">        {</span>
<span class="c">            setViewpoint( _homeViewpoint.value(), _homeViewpointDuration );</span>
<span class="c">        }</span>
<span class="c">        break;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_HOME</span><span class="p">:</span>
<span class="w">        </span><span class="n">home</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN_LEFT</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN_RIGHT</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN_UP</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_PAN_DOWN</span><span class="p">:</span>
<span class="w">        </span><span class="n">_task</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">TASK_PAN</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE_LEFT</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE_RIGHT</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE_UP</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ROTATE_DOWN</span><span class="p">:</span>
<span class="w">        </span><span class="n">_task</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">TASK_ROTATE</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ZOOM</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ZOOM_IN</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACTION_ZOOM_OUT</span><span class="p">:</span>
<span class="w">        </span><span class="n">_task</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">TASK_ZOOM</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">recalculateRoll</span><span class="p">()</span>
<span class="p">{</span>
<span class="cp">#if 0</span>
<span class="c">    vsg::dmat4 centerRotation = extract_rotation(_centerReferenceFrame);</span>

<span class="c">    vsg::dvec3 lookVector = -getUpVector(centerRotation);</span>
<span class="c">    vsg::dvec3 upVector = getFrontVector(centerRotation);</span>

<span class="c">    vsg::dvec3 localUp = getUpVector(_centerReferenceFrame);</span>

<span class="c">    vsg::dvec3 sideVector = vsg::cross(lookVector, localUp);</span>

<span class="c">    if (vsg::length(sideVector) &lt; 0.1)</span>
<span class="c">    {</span>
<span class="c">        //ROCKY_INFO&lt;&lt;&quot;Side vector short &quot;&lt;&lt;sideVector.length()&lt;&lt;std::endl;</span>

<span class="c">        sideVector = vsg::normalize(vsg::cross(upVector, localUp));</span>

<span class="c">    }</span>

<span class="c">    vsg::dvec3 newUpVector = vsg::normalize(vsg::cross(sideVector, lookVector));</span>

<span class="c">    vsg::dquat rotate_roll(upVector, newUpVector);</span>

<span class="c">    if (!rotate_roll.zeroRotation())</span>
<span class="c">    {</span>
<span class="c">        _centerRotation = _centerRotation * rotate_roll;</span>
<span class="c">    }</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">compositeEulerAngles</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">out_azim</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">out_pitch</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">getZAxis</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">));</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">getYAxis</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">centerRotation</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out_azim</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-0.9</span><span class="p">)</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">look</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalizeAzimRad</span><span class="p">(</span><span class="o">*</span><span class="n">out_azim</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out_pitch</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">out_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asin</span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="c1">// Extracts azim and pitch from a quaternion that does not contain any roll.</span>
<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">getEulerAngles</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">out_azim</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">out_pitch</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dmat4</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">getZAxis</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">getYAxis</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">out_azim</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-0.9</span><span class="p">)</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">up</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">look</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="n">out_azim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalizeAzimRad</span><span class="p">(</span><span class="o">*</span><span class="n">out_azim</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out_pitch</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">out_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asin</span><span class="p">(</span><span class="n">look</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">getQuaternion</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">azim</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">pitch</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="nf">azim_q</span><span class="p">(</span><span class="n">azim</span><span class="p">,</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dquat</span><span class="w"> </span><span class="nf">pitch_q</span><span class="p">(</span><span class="o">-</span><span class="n">pitch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="p">),</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">inverse</span><span class="p">(</span><span class="n">azim_q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pitch_q</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//vsg::dmat4 newRot = vsg::inverse(azim_q * pitch_q);</span>
<span class="w">    </span><span class="c1">//return vsg::rotate(vsg::inverse(newRot)); .getRotate();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">withinRenderArea</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">PointerEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pointerEvent</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_window_weakptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pointerEvent</span><span class="p">.</span><span class="n">window</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">renderArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">getRenderArea</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span>
<span class="w">        </span><span class="n">pointerEvent</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">pointerEvent</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">pointerEvent</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">pointerEvent</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">ndc</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">PointerEvent</span><span class="o">&amp;</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_camera_weakptr</span><span class="p">.</span><span class="n">ref_ptr</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">camera</span><span class="p">)</span>
<span class="w">        </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">renderArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camera</span><span class="o">-&gt;</span><span class="n">getRenderArea</span><span class="p">();</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">aspectRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<span class="w">    </span><span class="n">vsg</span><span class="o">::</span><span class="n">dvec2</span><span class="w"> </span><span class="n">v</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">aspectRatio</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">void</span>
<span class="n">MapManipulator</span><span class="o">::</span><span class="n">updateTether</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vsg</span><span class="o">::</span><span class="n">time_point</span><span class="o">&amp;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mapNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMapNode</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mapNode</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">pointFunction</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="n">setVP1</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">().</span><span class="n">transform</span><span class="p">(</span><span class="n">mapNode</span><span class="o">-&gt;</span><span class="n">srs</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// If we just called setViewpointFrame, no need to calculate the center again.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isSettingViewpoint</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">setCenter</span><span class="p">(</span><span class="n">to_vsg</span><span class="p">(</span><span class="n">world</span><span class="p">));</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">tetherMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TETHER_CENTER</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="n">lastTetherMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TETHER_CENTER_AND_ROTATION</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//TODO</span>
<span class="w">                </span><span class="c1">//vsg::dmat4 localToFrame(L2W * vsg::dmat4::inverse(_centerLocalToWorld));</span>
<span class="w">                </span><span class="c1">//double azim = atan2(-localToFrame(0, 1), localToFrame(0, 0));</span>
<span class="w">                </span><span class="c1">//_tetherRotation.makeRotate(-azim, 0.0, 0.0, 1.0);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="cp">#if 0</span>
<span class="c">        else</span>
<span class="c">        {</span>
<span class="c">            // remove any scaling introduced by the model</span>
<span class="c">            double sx = 1.0 / sqrt(L2W(0, 0) * L2W(0, 0) + L2W(1, 0) * L2W(1, 0) + L2W(2, 0) * L2W(2, 0));</span>
<span class="c">            double sy = 1.0 / sqrt(L2W(0, 1) * L2W(0, 1) + L2W(1, 1) * L2W(1, 1) + L2W(2, 1) * L2W(2, 1));</span>
<span class="c">            double sz = 1.0 / sqrt(L2W(0, 2) * L2W(0, 2) + L2W(1, 2) * L2W(1, 2) + L2W(2, 2) * L2W(2, 2));</span>
<span class="c">            L2W = L2W * osg::Matrixd::scale(sx, sy, sz);</span>

<span class="c">            if (settings.getTetherMode() == TETHER_CENTER_AND_HEADING)</span>
<span class="c">            {</span>
<span class="c">                // Back out the tetheree&#39;s rotation, then discard all but the heading component:</span>
<span class="c">                osg::Matrixd localToFrame(L2W * osg::Matrixd::inverse(_centerLocalToWorld));</span>
<span class="c">                double azim = atan2(-localToFrame(0, 1), localToFrame(0, 0));</span>

<span class="c">                osg::Quat finalTetherRotation;</span>
<span class="c">                finalTetherRotation.makeRotate(-azim, 0.0, 0.0, 1.0);</span>
<span class="c">                _tetherRotation.slerp(t, _tetherRotationVP0, finalTetherRotation);</span>
<span class="c">            }</span>

<span class="c">            // Track all rotations</span>
<span class="c">            else if (settings.getTetherMode() == TETHER_CENTER_AND_ROTATION)</span>
<span class="c">            {</span>
<span class="c">                osg::Quat finalTetherRotation;</span>
<span class="c">                finalTetherRotation = L2W.getRotate() * _centerRotation.inverse();</span>
<span class="c">                _tetherRotation.slerp(t, _tetherRotationVP0, finalTetherRotation);</span>
<span class="c">            }</span>
<span class="c">        }</span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="n">lastTetherMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">tetherMode</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Pelican Mapping.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>